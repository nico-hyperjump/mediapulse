---
title: Architecture
---

The project consists of multiple apps, agents, and packages.

## Project Structure

```
mediapulse/
├── apps/
│   ├── web/                    # Next.js user dashboard
│   │   ├── app/
│   │   │   ├── (auth)/
│   │   │   ├── dashboard/
│   │   │   ├── newsletters/
│   │   │   └── api/
│   │   └── components/
│   ├── admin/                  # Next.js admin dashboard
│   │   ├── app/
│   │   │   ├── (auth)/
│   │   │   ├── dashboard/
│   │   │   ├── agents/
│   │   │   ├── versions/
│   │   │   ├── config/
│   │   │   ├── users/
│   │   │   ├── monitoring/
│   │   │   └── api/
│   │   └── components/
│   └── worker/                  # Background job processor
│       └── agents/
│           ├── scheduler/
│           ├── query-strategy/
│           ├── data-collection/
│           ├── analysis/
│           ├── content-generation/
│           ├── quality-assurance/
│           ├── delivery/
│           └── learning/
├── packages/
│   ├── shared/                  # Shared types and utilities
│   ├── database/                # Prisma schema and migrations
│   ├── agents/                  # Agent implementations
│   ├── ai/                      # AI/LLM integration layer
│   └── email/                   # Email templates and sending
├── prisma/
│   └── schema.prisma
└── package.json                 # Turborepo monorepo config
```

## Database Schema

Key entities:

- `User` - Recipients with preferences
- `Ticker` - Company identifiers being monitored
- `UserTicker` - User-company subscriptions with custom schedules
- `DataSource` - Scraped articles, social posts, market data
- `Newsletter` - Generated newsletter instances
- `NewsletterContent` - Sections and insights within newsletters
- `UserFeedback` - Ratings, clicks, engagement metrics
- `AgentMetrics` - Performance tracking for self-improvement
- `ABTest` - A/B testing configurations and results
- `AgentVersion` - Agent version history and metadata
- `AgentVersionDeployment` - Production deployment assignments (which version is active)
- `AgentExperiment` - Experimental runs and version comparisons
- `AgentValidation` - Validation checks before version promotion
- `AgentPromptVersion` - Prompt template versioning
- `AnalysisTypeRegistry` - Registered analysis types and their metadata

## Analysis Plugin System

The Analysis Agent uses a **plugin-based architecture** that allows analysis types to be dynamically registered, configured, and executed without code changes. This design provides maximum flexibility for adding, removing, or modifying analysis capabilities.

### Plugin Registry

Analysis types are registered in the `AnalysisTypeRegistry` database table, which stores:

- **Analysis Type Metadata**:
  - `id: string` - Unique identifier (e.g., 'sentiment', 'competitive', 'event')
  - `name: string` - Human-readable name
  - `version: string` - Plugin version
  - `description: string` - What the analysis does
  - `enabled: boolean` - Whether the analysis type is active
  - `configSchema: object` - Zod schema for configuration validation
  - `outputSchema: object` - Zod schema for output validation
  - `sectionTemplate?: string` - Optional template for content generation

### Dynamic Loading Mechanism

1. **Plugin Discovery**: On initialization, the Analysis Agent queries `AnalysisTypeRegistry` for all enabled analysis types
2. **Plugin Loading**: Each registered analysis type is loaded with its configuration from `AgentConfig`
3. **Runtime Execution**: Analysis types are executed in parallel based on the `analysisTypes` parameter
4. **Hot Reload**: Changes to the registry or configurations trigger agent re-initialization without restart

### Plugin Interface

All analysis plugins must implement the standard interface:

```typescript
interface AnalysisPlugin {
  id: string
  name: string
  version: string
  execute: (data: CollectedData, config: AnalysisConfig) => Promise<AnalysisResult>
  validateConfig: (config: any) => boolean
  getOutputSchema: () => ZodSchema
  getSectionTemplate?: () => string // Optional: for content generation
}
```

### Adding New Analysis Types

New analysis types can be added through:

1. **Admin Interface**: Register via `/admin/agents/analysis-types` dashboard
2. **Database Direct**: Insert into `AnalysisTypeRegistry` table
3. **Configuration**: Add analysis type config to `AgentConfig` for the analysis agent

Once registered, the analysis type is immediately available for use without code deployment.

### Configuration Integration

Analysis type configurations are stored in `AgentConfig` with the following structure:

```typescript
{
  analysis: {
    enabledTypes: string[], // Which analysis types to run
    [analysisTypeId: string]: {
      // Type-specific configuration
      enabled: boolean,
      // ... type-specific settings
    }
  }
}
```

The configuration hierarchy applies:
- User-specific analysis preferences (can enable/disable specific types)
- Ticker-specific overrides (different analyses per company)
- Agent-specific defaults from `AgentConfig`
- System-wide defaults from `SystemConfig`

## Configuration Management System

**All configurations are stored in the database and loaded dynamically. No hardcoded values.**

### Configuration Storage

- **Database Tables**:

  - `AgentConfig` - Per-agent configurations (JSONB column with versioning)
  - `SourceConfig` - Data source configurations (news sites, APIs, etc.)
  - `UserPreferences` - User-specific preferences
  - `SystemConfig` - Global system settings
  - `ABTestConfig` - A/B testing configurations
  - `AnalysisTypeRegistry` - Registered analysis types and their metadata (see Analysis Plugin System)

- **Configuration Loading**:

  - Configs loaded at agent initialization from database
  - Cached with TTL (configurable via SystemConfig)
  - Hot-reloadable via admin API endpoint
  - Versioned for rollback capability
  - Config changes trigger agent re-initialization

- **Configuration Hierarchy** (priority order):

  1. User-specific preferences (highest priority)
  2. Ticker-specific overrides
  3. Agent-specific runtime overrides
  4. Agent-specific defaults from AgentConfig table
  5. System-wide defaults from SystemConfig table (lowest priority)

- **Configuration Schema**:
  - All configs stored as JSONB in PostgreSQL
  - Schema validation using Zod schemas
  - Type-safe config loading with TypeScript
  - Config migration system for version updates
